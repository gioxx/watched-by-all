<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Watched: Episodes details</title>
    <link rel="icon" type="image/webp" href="/static/watched_icon.webp" />
    <link rel="stylesheet" href="/static/styles.css" />
</head>

<body>
    <header>
        <div class="header-left">
            <button id="backBtn" class="pill" onclick="window.history.back()">‚Üê Back</button>
            <div class="brand">
                <img src="/static/watched_icon.webp" alt="" width="34" height="34" />
                <div>
                    <h1 id="seriesTitle">Serie</h1>
                    <div class="muted" id="seriesInfo"></div>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <select id="langSelect" class="pill lang-select" aria-label="Language">
                <option value="en">EN</option>
                <option value="it">IT</option>
            </select>
            <button id="themeToggle" class="pill icon-btn" type="button" aria-label="Toggle theme">üåô</button>
        </div>
    </header>
    <main>
        <div id="seasons"></div>
    </main>

    <script>
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('user') || '';
        const seriesId = params.get('seriesId') || '';
        const seriesName = params.get('seriesName') ? decodeURIComponent(params.get('seriesName')) : '';

        let translations = {};
        let currentLang = localStorage.getItem('lang') || 'en';
        let currentTheme = localStorage.getItem('theme') || 'dark';

        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"']/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[c]));
        }

        function t(key, vars = {}) {
            const base = translations[key] || key;
            return Object.keys(vars).reduce((acc, k) => acc.replace(new RegExp(`{${k}}`, 'g'), vars[k]), base);
        }

        async function loadLang(lang) {
            currentLang = lang;
            try {
                const r = await fetch(`/static/locales/${lang}.json`);
                translations = await r.json();
            } catch (e) {
                translations = {};
            }
            localStorage.setItem('lang', lang);
            applyStaticText();
        }

        function applyStaticText() {
            document.title = t('title');
            document.getElementById('seriesTitle').textContent = seriesName || t('label.tvSeries');
            document.getElementById('backBtn').textContent = t('detail.back');
            document.getElementById('langSelect').value = currentLang;
            document.getElementById('langSelect').querySelectorAll('option').forEach(opt => {
                const code = (opt.value || '').toUpperCase();
                opt.textContent = `${t('header.langIcon')} ${code}`;
            });
            document.getElementById('themeToggle').setAttribute('aria-label', currentTheme === 'light' ? t('theme.dark') : t('theme.light'));
        }

        document.getElementById('seriesTitle').textContent = seriesName || 'Series';

        function applyTheme(theme) {
            currentTheme = theme === 'light' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            document.getElementById('themeToggle').textContent = currentTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
            document.getElementById('themeToggle').setAttribute('aria-label', currentTheme === 'light' ? t('theme.dark') : t('theme.light'));
        }

        async function loadDetail() {
            if (!userId || !seriesId) {
                document.getElementById('seriesInfo').textContent = t('detail.missingParams');
                return;
            }
            const res = await fetch(`/api/user/${encodeURIComponent(userId)}/history`);
            const data = await res.json();
            // Deduplicate episodes by episodeId/providerKey; keep latest date
            const raw = (data.items || []).filter(e => e.seriesId === seriesId);
            const byEp = new Map();
            raw.forEach(e => {
                const key = e.episodeId || e.ratingKey || e.providerKey || `${e.seriesId}:${e.seasonIndex}:${e.episodeIndex}:${e.title}`;
                const prev = byEp.get(key);
                if (!prev || (e.date || 0) > (prev.date || 0)) {
                    byEp.set(key, e);
                }
            });
            const epis = Array.from(byEp.values());
            if (epis.length === 0) {
                document.getElementById('seriesInfo').textContent = t('detail.noEpisodes');
                return;
            }
            const bySeason = {};
            epis.forEach(ep => {
                const key = ep.seasonName || `Season ${ep.seasonIndex || ''}` || 'Season';
                if (!bySeason[key]) bySeason[key] = [];
                bySeason[key].push(ep);
            });
            Object.values(bySeason).forEach(arr => {
                arr.sort((a,b) => (b.date || 0) - (a.date || 0));
            });
            const seasons = Object.entries(bySeason).sort((a,b) => {
                const la = a[1][0]?.date || 0;
                const lb = b[1][0]?.date || 0;
                return lb - la;
            });
            const container = document.getElementById('seasons');
            container.innerHTML = seasons.map(([name, eps]) => {
                const lastDate = eps.reduce((m,e) => Math.max(m, e.date || 0), 0);
                const lastDateStr = lastDate ? new Date(lastDate * 1000).toLocaleString() : '‚Äî';
                const epiHtml = eps.map(e => {
                    const code = (e.seasonIndex != null && e.episodeIndex != null)
                        ? `S${String(e.seasonIndex).padStart(2,'0')}E${String(e.episodeIndex).padStart(2,'0')}`
                        : '';
                    const when = e.date ? new Date(e.date * 1000).toLocaleString() : '‚Äî';
                    const coverSrc = e.thumb || e.jellyfinThumb || '';
                    const cover = coverSrc
                        ? `<img src="${escapeHtml(coverSrc)}" alt="">`
                        : `<span class="muted">${escapeHtml(t('label.noPoster'))}</span>`;
                    const epTitle = (e.title && e.title !== seriesName) ? e.title : (e.episodeTitle || '');
                    const seasonLabel = e.seasonName || '';
                    return `<div class="episode">
                        <div class="episode-cover">${cover}</div>
                        <div style="flex:1 1 auto;">
                            <div class="epi-title">${escapeHtml(code ? code + ' ¬∑ ' : '')}${escapeHtml(epTitle)}</div>
                            <div class="epi-sub">${escapeHtml(seasonLabel)}</div>
                        </div>
                        <div class="episode-viewed">${t('detail.viewed')}: ${escapeHtml(when)}</div>
                    </div>`;
                }).join('');
                return `<div class="season-block">
                    <div class="season-head">
                        <div>
                            <div class="epi-title section-title" style="padding-top:0;">${escapeHtml(name)}</div>
                            <div class="epi-sub">${t('detail.lastViewed')}: ${escapeHtml(lastDateStr)}</div>
                        </div>
                        <div class="epi-sub">${t('detail.episodesCount', {count: eps.length})}</div>
                    </div>
                    <div class="episode-list">${epiHtml}</div>
                </div>`;
            }).join('');

            document.getElementById('seriesInfo').textContent = t('detail.seriesInfo', { series: seriesName || '', count: epis.length });
        }

        (async () => {
            await loadLang(currentLang);
            applyTheme(currentTheme);
            await loadDetail();
        })();

        document.getElementById('langSelect').addEventListener('change', async (e) => {
            await loadLang(e.target.value);
            await loadDetail();
        });

        document.getElementById('themeToggle').addEventListener('click', () => {
            applyTheme(currentTheme === 'light' ? 'dark' : 'light');
        });
    </script>
</body>
</html>
