<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Watched</title>
    <link rel="icon" type="image/webp" href="/static/watched_icon.webp" />
    <link rel="stylesheet" href="/static/styles.css" />
</head>

<body>
    <div id="bootLoading" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(120deg, rgba(9,13,23,.9), rgba(14,19,32,.9)); color:#e8eefc; z-index:9999; font-size:18px; gap:10px;">
        <span>‚è≥</span>
        <span id="bootLoadingText">Loading data‚Ä¶</span>
    </div>
    <header>
        <div class="brand">
            <img src="/static/watched_icon.webp" alt="" width="44" height="44" aria-hidden="true" />
            <span id="brandTitle">Watched</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
            <button id="btnUsers" class="pill" style="cursor:pointer;">üë• Users</button>
            <div id="summary" class="pill">‚ÑπÔ∏è Loading‚Ä¶</div>
            <select id="langSelect" class="pill lang-select" style="cursor:pointer;">
                <option value="en">EN</option>
                <option value="it">IT</option>
            </select>
            <button id="themeToggle" class="pill icon-btn" type="button" aria-label="Toggle theme">üåô</button>
            <a class="pill icon-btn" href="https://github.com/gioxx/watched-by-all" target="_blank" rel="noopener noreferrer" aria-label="GitHub repository">
                <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M12 .5C5.65.5.5 5.65.5 12c0 5.1 3.29 9.42 7.86 10.95.58.12.79-.25.79-.56 0-.28-.01-1.02-.02-2-3.2.69-3.88-1.54-3.88-1.54-.53-1.33-1.29-1.68-1.29-1.68-1.06-.72.08-.71.08-.71 1.17.08 1.79 1.21 1.79 1.21 1.04 1.78 2.73 1.27 3.4.97.11-.76.41-1.27.75-1.56-2.56-.29-5.26-1.28-5.26-5.7 0-1.26.45-2.28 1.2-3.08-.12-.29-.52-1.47.12-3.06 0 0 .97-.31 3.18 1.18a11.1 11.1 0 0 1 2.9-.39c.99 0 1.99.13 2.92.39 2.2-1.49 3.17-1.18 3.17-1.18.64 1.59.24 2.77.12 3.06.75.8 1.2 1.82 1.2 3.08 0 4.43-2.7 5.41-5.28 5.69.42.36.8 1.07.8 2.16 0 1.56-.01 2.81-.01 3.19 0 .31.21.68.8.56A10.52 10.52 0 0 0 23.5 12C23.5 5.65 18.35.5 12 .5Z"/>
                </svg>
            </a>
        </div>
    </header>

    <main>
        <div id="backendStatus" style="display:none; margin-bottom:10px; padding:10px 12px; border-radius:12px; border:1px solid #613b2f; background:#2d1a15; color:#f3d9d0; font-weight:600;">
            ‚ö†Ô∏è Jellyfin unreachable. Check URL/network and retry.
        </div>
        <div class="tabs">
            <button id="tabMovies" class="active">Movies</button>
            <button id="tabShows">Seasons (complete)</button>
            <button id="tabHistory">User history</button>
        </div>

        <div class="row">
            <input id="search" placeholder="Search title‚Ä¶" />
            <span id="count" class="pill">‚Äî</span>
            <button id="refresh">Refresh</button>
        </div>

        <div id="historyControls" class="row" style="display:none;">
            <select id="historyUser" class="pill" style="min-width:240px; padding:10px 12px;"></select>
            <span class="muted">Select the user to see everything they watched.</span>
        </div>

        <div id="grid" class="grid"></div>

        <div class="footer">
            Definition: a title appears here only if it is marked as watched by <b>all</b> users.
        </div>
    </main>

        <div id="usersModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55);">
        <div style="max-width:720px; margin:8vh auto; background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden;">
            <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 14px; border-bottom:1px solid var(--border);">
                <div style="font-weight:700;" data-i18n="users.title">Selected users</div>
                <button id="btnCloseUsers">Close</button>
            </div>
            <div style="padding:14px 14px; display:flex; flex-direction:column; gap:10px;">
                <div class="muted" data-i18n="users.note">If you do not select anyone, <b>all</b> users will be considered.</div>
                <div class="muted" data-i18n="label.usersDetected">Detected users</div>
                <div id="usersList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:10px;"></div>
                <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; padding-top:6px;">
                    <button id="btnSelectAll">Select all</button>
                    <button id="btnSelectNone">None (all)</button>
                    <button id="btnApplyUsers">Apply + refresh</button>
                    <button id="btnForceRefresh">Force refresh</button>
                </div>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-backdrop">
        <div class="modal-panel">
            <div class="modal-header">
                <div id="historyModalTitle" style="font-weight:700;"></div>
                <button id="btnCloseHistory">Chiudi</button>
            </div>
            <div class="modal-body" id="historyModalBody"></div>
        </div>
    </div>

    <script>
        let translations = {};
        let currentLang = 'en';
        const bootLoading = document.getElementById('bootLoading');
        const bootLoadingText = document.getElementById('bootLoadingText');
        const backendStatus = document.getElementById('backendStatus');

        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, (c) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[c]));
        }

        function t(key, vars = {}) {
            const base = translations[key] || translations[key.replace(/:[^.]*/, '')] || key;
            return Object.keys(vars).reduce((acc, k) => acc.replace(new RegExp(`{${k}}`, 'g'), vars[k]), base);
        }

        function setBackendStatus(message = '', visible = false) {
            if (!backendStatus) return;
            backendStatus.textContent = message || '‚ö†Ô∏è Jellyfin unreachable. Check URL/network and retry.';
            backendStatus.style.display = visible ? 'block' : 'none';
        }

        let currentTheme = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', currentTheme);

        const grid = document.getElementById('grid');
        const summary = document.getElementById('summary');
        const count = document.getElementById('count');
        const search = document.getElementById('search');
        const tabMovies = document.getElementById('tabMovies');
        const tabShows = document.getElementById('tabShows');
        const tabHistory = document.getElementById('tabHistory');
        const refreshBtn = document.getElementById('refresh');

        const btnUsers = document.getElementById('btnUsers');
        const langSelect = document.getElementById('langSelect');
        const usersModal = document.getElementById('usersModal');
        const btnCloseUsers = document.getElementById('btnCloseUsers');
        const usersList = document.getElementById('usersList');
        const btnApplyUsers = document.getElementById('btnApplyUsers');
        const btnSelectAll = document.getElementById('btnSelectAll');
        const btnSelectNone = document.getElementById('btnSelectNone');
        const btnForceRefresh = document.getElementById('btnForceRefresh');
        const historyControls = document.getElementById('historyControls');
        const historyUser = document.getElementById('historyUser');
        const historyModal = document.getElementById('historyModal');
        const historyModalTitle = document.getElementById('historyModalTitle');
        const historyModalBody = document.getElementById('historyModalBody');
        const btnCloseHistory = document.getElementById('btnCloseHistory');
        const themeToggle = document.getElementById('themeToggle');

        async function loadLang(lang) {
            currentLang = lang;
            try {
                const r = await fetch(`/static/locales/${lang}.json`);
                translations = await r.json();
            } catch (e) {
                translations = {};
            }
            localStorage.setItem('lang', lang);
            applyStaticText();
            render();
        }

        function applyStaticText() {
            document.title = t('title');
            document.getElementById('brandTitle').textContent = t('title');
            tabMovies.textContent = t('tab.movies');
            tabShows.textContent = t('tab.shows');
            tabHistory.textContent = t('tab.history');
            search.placeholder = t('search.placeholder');
            refreshBtn.textContent = t('button.refresh');
            btnUsers.textContent = `${t('header.usersIcon')} ${t('header.users')}`;
            document.getElementById('historyControls').querySelector('.muted').textContent = t('history.helper');
            document.querySelector('.footer').innerHTML = t('footer.text');

            // Users modal
            document.querySelector('#usersModal [data-i18n="users.title"]').textContent = t('usersModal.title');
            document.getElementById('btnCloseUsers').textContent = t('usersModal.close');
            document.querySelector('#usersModal [data-i18n="users.note"]').innerHTML = t('usersModal.note');
            document.querySelector('#usersModal [data-i18n="label.usersDetected"]').textContent = t('label.usersDetected');
            btnSelectAll.textContent = t('usersModal.selectAll');
            btnSelectNone.textContent = t('usersModal.selectNone');
            btnApplyUsers.textContent = t('usersModal.apply');
            btnForceRefresh.textContent = t('usersModal.force');

            langSelect.value = currentLang;
            langSelect.querySelectorAll('option').forEach(opt => {
                const code = (opt.value || '').toUpperCase();
                opt.textContent = `${t('header.langIcon')} ${code}`;
            });

            if (themeToggle) {
                themeToggle.setAttribute('aria-label', currentTheme === 'light' ? t('theme.dark') : t('theme.light'));
            }
            if (bootLoadingText) bootLoadingText.textContent = t('loading') || 'Loading data‚Ä¶';
        }

        let allUsers = [];
        let selectedUserIds = new Set();

        function applyTheme(theme) {
            currentTheme = theme === 'light' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            if (themeToggle) {
                themeToggle.textContent = currentTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
                themeToggle.setAttribute('aria-label', currentTheme === 'light' ? t('theme.dark') : t('theme.light'));
            }
        }

        function openUsers() { usersModal.style.display = 'block'; }
        function closeUsers() { usersModal.style.display = 'none'; }

        function renderUsers() {
            usersList.innerHTML = allUsers.map(u => {
                const checked = selectedUserIds.has(u.user_id) ? 'checked' : '';
                return `
        <label style="display:flex; gap:10px; align-items:center; border:1px solid var(--border); border-radius:12px; padding:10px;">
          <input type="checkbox" data-user-id="${u.user_id}" ${checked} />
          <span>${escapeHtml(u.name)} <span class="muted ellipsis">(${escapeHtml(u.user_id)})</span></span>
        </label>
      `;
            }).join('');

            usersList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const id = e.target.getAttribute('data-user-id');
                    if (e.target.checked) selectedUserIds.add(id);
                    else selectedUserIds.delete(id);
                });
            });
        }

        async function loadUsers() {
            try {
                const r = await fetch('/api/users');
                if (!r.ok) throw new Error('users');
                const data = await r.json();
                allUsers = (data.users || []).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                selectedUserIds = new Set(data.selected_user_ids || []);
                renderUsers();
                setBackendStatus('', false);
            } catch (e) {
                setBackendStatus(t('loadingError') || '‚ö†Ô∏è Jellyfin unreachable. Retry.', true);
                allUsers = [];
                selectedUserIds = new Set();
                renderUsers();
            }

            // Populate history select
            const prev = historyUser.value;
            historyUser.innerHTML = allUsers.map(u => `<option value="${u.user_id}">${escapeHtml(u.name)} (${escapeHtml(u.user_id)})</option>`).join('');
            if (prev && allUsers.some(u => u.user_id === prev)) {
                historyUser.value = prev;
            }

        }

        async function applyUsers() {
            await fetch('/api/selected-users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ selected_user_ids: Array.from(selectedUserIds) })
            });
            await loadSummary();
            await loadItems();
        }

        async function forceRefresh() {
            await fetch('/api/refresh', { method: 'POST' });
            await loadSummary();
            await loadItems();
        }

        let mode = 'movies';
        let items = [];

        function cardHTML(it) {
            const year = it.year ? ` (${it.year})` : '';
            const runtime = it.runtimeMinutes ? `${it.runtimeMinutes} min` : '';
            const ratingBits = [];
            if (it.officialRating) ratingBits.push(escapeHtml(it.officialRating));
            if (it.communityRating) ratingBits.push(`‚òÖ ${escapeHtml(it.communityRating)}`);
            if (typeof it.playCount === 'number') ratingBits.push(t('label.playcount', {count: it.playCount}));
            const subline = mode === 'shows'
              ? runtime
              : [runtime, ratingBits.join(' ¬∑ ')].filter(Boolean).join(' ¬∑ ');
            return `
        <div class="card">
          <div class="poster">
            ${it.thumb ? `<img src="${it.thumb}" alt="">` : `<span class="muted">${t('label.noPoster')}</span>`}
          </div>
          <div class="meta">
            <div class="title">${escapeHtml(it.title)}${escapeHtml(year)}</div>
            <div class="sub">${subline}</div>
          </div>
        </div>
      `;
        }

        function historyHTML(it) {
            const date = it.date ? new Date(it.date * 1000).toLocaleString() : '‚Äî';
            const thumb = it.seriesThumb || it.thumb || it.jellyfinThumb || '';
            const isEpisode = !!it.seriesName;
            const code = (it.seasonIndex != null && it.episodeIndex != null)
              ? `S${String(it.seasonIndex).padStart(2,'0')}E${String(it.episodeIndex).padStart(2,'0')}`
              : '';
            const episodeLine = isEpisode
              ? [it.seasonName, code, it.title].filter(Boolean).map(escapeHtml).join(' ¬∑ ')
              : '';
            return `
        <div class="card">
          <div class="poster">
            ${thumb ? `<img src="${thumb}" alt="">` : `<span class="muted">${t('label.noPoster')}</span>`}
          </div>
          <div class="meta">
            <div class="title">${isEpisode ? escapeHtml(it.seriesName || '') : escapeHtml(it.title || '')}</div>
            <div class="muted">${episodeLine ? `${episodeLine} ¬∑ ` : ''}${t('label.viewed')}: ${escapeHtml(date)}</div>
          </div>
        </div>
      `;
        }

        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, (c) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[c]));
        }

        function render() {
            const q = search.value.trim().toLowerCase();
            const filtered = q ? items.filter(i => (i.title || '').toLowerCase().includes(q)) : items;
            if (mode === 'history') {
                grid.classList.remove('grid');
                grid.style.display = 'block';
                const movies = filtered.filter(i => !i.seriesName);
                const episodes = filtered.filter(i => i.seriesName);
                const grouped = {};
                episodes.forEach(e => {
                    const key = e.seriesId || e.seriesName || 'Serie';
                    if (!grouped[key]) grouped[key] = { meta: e, items: [], lastDate: 0, key };
                    grouped[key].items.push(e);
                    if (e.date && e.date > grouped[key].lastDate) grouped[key].lastDate = e.date;
                });
                const groupsArray = Object.entries(grouped).map(([k, v]) => ({ key: k, ...v }));
                groupsArray.sort((a, b) => (b.lastDate || 0) - (a.lastDate || 0));
                const moviesHtml = movies.length ? `<div class="section-block"><div class="grid">${movies.map(historyHTML).join('')}</div></div>` : '';
                const seriesCards = groupsArray.map(g => {
                    const header = `${escapeHtml(g.meta.seriesName || g.meta.title || '')}`.trim();
                    const lastDateStr = g.lastDate ? new Date(g.lastDate * 1000).toLocaleString() : '‚Äî';
                    const coverSrc = g.meta?.seriesThumb || g.items[0]?.seriesThumb || g.items[0]?.thumb;
                    const cover = coverSrc
                      ? `<img src="${coverSrc}" alt="">`
                      : `<span class="muted">${t('label.noPoster')}</span>`;
                    const seriesId = g.meta?.seriesRatingKey || g.meta?.seriesId || g.items[0]?.seriesId || g.key || "";
                    return `
        <div class="card">
          <div class="poster">
            ${cover}
          </div>
          <div class="meta">
            <div class="title">${header}</div>
            <div class="muted">${t('label.viewed')}: ${escapeHtml(lastDateStr)}</div>
            <button class="pill" data-series-id="${seriesId}" data-series-name="${escapeHtml(header)}" style="padding:6px 10px; margin-top:6px;">${t('button.episodesDetail')}</button>
          </div>
        </div>`;
                }).join('');
                const spacer = moviesHtml && seriesCards ? `<div style="height:18px;"></div>` : '';
                const seriesHtml = seriesCards ? `<p class="section-title">${t('label.tvSeries')}</p><div class="section-block"><div class="grid">${seriesCards}</div></div>` : '';
                grid.innerHTML = `${moviesHtml}${spacer}${seriesHtml}`;

                grid.querySelectorAll('button[data-series-id]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const seriesId = btn.getAttribute('data-series-id') || '';
                        const seriesName = btn.getAttribute('data-series-name') || '';
                        if (!historyUser.value || !seriesId) return;
                        const url = `/static/history_detail.html?user=${encodeURIComponent(historyUser.value)}&seriesId=${encodeURIComponent(seriesId)}&seriesName=${encodeURIComponent(seriesName)}`;
                        window.location.href = url;
                    });
                });
            } else {
                grid.classList.add('grid');
                grid.style.display = '';
                grid.innerHTML = filtered.map(cardHTML).join('');
            }
            count.textContent = `${filtered.length} / ${items.length}`;
        }

        async function loadSummary() {
            try {
                const r = await fetch('/api/summary');
                if (!r.ok) throw new Error('summary');
                const s = await r.json();
                const date = s.lastRefresh ? new Date(s.lastRefresh * 1000).toLocaleString() : '‚Äî';
                summary.textContent = `${t('header.summaryIcon')} ${t('summary.template', { users: s.users, movies: s.moviesByAll, seasons: s.showsByAll, date })}`;
                setBackendStatus('', false);
            } catch (e) {
                setBackendStatus(t('loadingError') || '‚ö†Ô∏è Jellyfin unreachable. Retry.', true);
                summary.textContent = `${t('header.summaryIcon')} ‚Äî`;
            }
        }

        async function loadItems() {
            grid.innerHTML = '';
            count.textContent = '‚Äî';
            if (mode === 'history') {
                if (!historyUser.value && allUsers.length > 0) {
                    historyUser.value = allUsers[0].user_id;
                }
                if (!historyUser.value) {
                    items = [];
                    render();
                    return;
                }
                try {
                    const r = await fetch(`/api/user/${encodeURIComponent(historyUser.value)}/history`);
                    if (!r.ok) throw new Error('history');
                    const data = await r.json();
                    items = data.items || [];
                    render();
                    setBackendStatus('', false);
                    return;
                } catch (e) {
                    setBackendStatus(t('loadingError') || '‚ö†Ô∏è Jellyfin unreachable. Retry.', true);
                    items = [];
                    render();
                    return;
                }
            }

            const url = mode === 'movies' ? '/api/movies' : '/api/shows';
            try {
                const r = await fetch(url);
                if (!r.ok) throw new Error('items');
                const data = await r.json();
                items = data.items || [];
                render();
                setBackendStatus('', false);
            } catch (e) {
                setBackendStatus(t('loadingError') || '‚ö†Ô∏è Jellyfin unreachable. Retry.', true);
                items = [];
                render();
            }
        }

        tabMovies.addEventListener('click', async () => {
            mode = 'movies';
            tabMovies.classList.add('active');
            tabShows.classList.remove('active');
            tabHistory.classList.remove('active');
            historyControls.style.display = 'none';
            await loadItems();
        });

        tabShows.addEventListener('click', async () => {
            mode = 'shows';
            tabShows.classList.add('active');
            tabMovies.classList.remove('active');
            tabHistory.classList.remove('active');
            historyControls.style.display = 'none';
            await loadItems();
        });

        tabHistory.addEventListener('click', async () => {
            mode = 'history';
            tabHistory.classList.add('active');
            tabMovies.classList.remove('active');
            tabShows.classList.remove('active');
            historyControls.style.display = 'flex';
            await loadItems();
        });

        search.addEventListener('input', render);

        refreshBtn.addEventListener('click', async () => {
            await loadSummary();
            await loadItems();
        });

        btnUsers.addEventListener('click', async () => {
            await loadUsers();
            openUsers();
        });

        btnCloseUsers.addEventListener('click', closeUsers);
        usersModal.addEventListener('click', (e) => { if (e.target === usersModal) closeUsers(); });

        btnSelectAll.addEventListener('click', () => {
            selectedUserIds = new Set(allUsers.map(u => u.user_id));
            renderUsers();
        });

        btnSelectNone.addEventListener('click', () => {
            selectedUserIds = new Set();
            renderUsers();
        });

        btnApplyUsers.addEventListener('click', async () => {
            await applyUsers();
            closeUsers();
        });

        btnForceRefresh.addEventListener('click', async () => {
            await forceRefresh();
        });

        langSelect.addEventListener('change', async (e) => {
            await loadLang(e.target.value);
            await loadSummary();
            await loadItems();
        });

        themeToggle.addEventListener('click', () => {
            applyTheme(currentTheme === 'light' ? 'dark' : 'light');
        });

        function openHistoryModal(title, epis) {
            historyModalTitle.textContent = title || 'Dettaglio episodi';
            historyModalBody.innerHTML = epis.map(historyHTML).join('');
            historyModal.style.display = 'flex';
        }

        function closeHistoryModal() {
            historyModal.style.display = 'none';
            historyModalBody.innerHTML = '';
        }

        btnCloseHistory.addEventListener('click', closeHistoryModal);
        historyModal.addEventListener('click', (e) => { if (e.target === historyModal) closeHistoryModal(); });

        historyUser.addEventListener('change', async () => {
            if (mode === 'history') {
                await loadItems();
            }
        });

        (async () => {
            const storedLang = localStorage.getItem('lang') || 'en';
            await loadLang(storedLang);
            applyTheme(currentTheme);
            try {
                await loadSummary();
                try { await loadUsers(); } catch (e) { }
                await loadItems();
            } finally {
                if (bootLoading) bootLoading.style.display = 'none';
            }
        })();
    </script>
</body>

</html>
